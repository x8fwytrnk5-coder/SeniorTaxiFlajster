<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>SeniorTaxi / Doktor Flajster – kalkulačka</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1b2130 0, #05060a 55%);
      color: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    .app {
      max-width: 520px;
      margin: 0 auto;
      background: rgba(15, 17, 26, 0.96);
      border-radius: 20px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      border: 1px solid #262a3a;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
      letter-spacing: 0.02em;
    }
    .subtitle {
      font-size: 12px;
      color: #a0a4b8;
      margin-bottom: 14px;
    }
    label {
      font-size: 12px;
      display: block;
      margin-bottom: 4px;
      color: #c5c8d8;
    }
    input[type="text"] {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #33384a;
      background: #0d1018;
      color: #f5f5f5;
      font-size: 14px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    input[type="text"]:focus {
      border-color: #3ddcff;
      box-shadow: 0 0 0 1px #3ddcff33;
      background: #090b12;
    }
    .field {
      margin-bottom: 14px;
      position: relative;
    }
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #0d1018;
      border-radius: 10px;
      margin-top: 4px;
      border: 1px solid #33384a;
      max-height: 180px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }
    .suggestion-item {
      padding: 7px 9px;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 1px solid #1a1e2a;
    }
    .suggestion-item:last-child {
      border-bottom: none;
    }
    .suggestion-item:hover {
      background: #181c28;
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .row > * {
      flex: 1;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg, #3ddcff, #00ffa3);
      color: #000;
      font-weight: 600;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, opacity 0.15s;
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
      white-space: nowrap;
    }
    button.secondary {
      background: #222633;
      color: #f5f5f5;
      box-shadow: none;
    }
    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .mode-toggle {
      display: flex;
      border-radius: 999px;
      background: #0d1018;
      padding: 3px;
      margin-bottom: 10px;
      border: 1px solid #262a3a;
    }
    .mode-option {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      font-size: 12px;
      border-radius: 999px;
      cursor: pointer;
      color: #a0a4b8;
      transition: background 0.15s, color 0.15s, transform 0.1s;
    }
    .mode-option.active {
      background: linear-gradient(135deg, #3ddcff, #00ffa3);
      color: #000;
      font-weight: 600;
      transform: translateY(-1px);
    }
    .result {
      margin-top: 14px;
      padding: 11px 12px;
      border-radius: 12px;
      background: #0d1018;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid #33384a;
      animation: fadeIn 0.25s ease-out;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #222633;
      color: #ccc;
      margin-bottom: 6px;
    }
    .warning {
      color: #ffcc66;
      font-size: 12px;
      margin-top: 6px;
    }
    .small {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }
    #map {
      height: 220px;
      border-radius: 14px;
      margin-bottom: 14px;
      border: 1px solid #262a3a;
      overflow: hidden;
    }
    .legend {
      font-size: 11px;
      color: #a0a4b8;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>SeniorTaxi / Doktor Flajster</h1>
    <div class="subtitle">Test výpočtu ceny s reálnou trasou, GPS a našeptávaním adries.</div>

    <div id="map"></div>
    <div class="legend">Mapa: modrá – vodič, žltá – nástup, červená – výstup.</div>

    <div class="field">
      <label>Poloha vodiča</label>
      <input type="text" id="driverInput" placeholder="Zadajte adresu alebo použite GPS">
      <div id="driverSuggestions" class="suggestions" style="display:none;"></div>
      <div class="row" style="margin-top:6px;">
        <button class="secondary" id="useGps">Použiť moju polohu (GPS)</button>
      </div>
    </div>

    <div class="field">
      <label>Adresa nástupu klienta</label>
      <input type="text" id="pickupInput" placeholder="Zadajte adresu nástupu">
      <div class="row" style="margin-top:6px;">
        <button class="secondary" id="useDriverAsPickup">Použiť polohu vodiča ako nástup</button>
      </div>
      <div id="pickupSuggestions" class="suggestions" style="display:none;"></div>
    </div>

    <div class="field">
      <label>Adresa výstupu klienta</label>
      <input type="text" id="dropoffInput" placeholder="Zadajte adresu výstupu">
      <div id="dropoffSuggestions" class="suggestions" style="display:none;"></div>
    </div>

    <div class="field">
      <label>Typ jazdy</label>
      <div class="mode-toggle">
        <div class="mode-option active" data-mode="taxi" id="modeTaxi">Taxi</div>
        <div class="mode-option" data-mode="doktor" id="modeDoktor">Doktor Flajster</div>
      </div>
    </div>

    <div class="field">
      <button id="calculateBtn">Vypočítať cenu</button>
    </div>

    <div id="result" class="result" style="display:none;"></div>
<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  const ORS_API_KEY =
    "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjVjNDY1YWFiMTFjNjQ4MWM4MWM0M2RhOWI5MmZiMDg3IiwiaCI6Im11cm11cjY0In0=";

  const driverInput = document.getElementById("driverInput");
  const pickupInput = document.getElementById("pickupInput");
  const dropoffInput = document.getElementById("dropoffInput");

  const driverSuggestions = document.getElementById("driverSuggestions");
  const pickupSuggestions = document.getElementById("pickupSuggestions");
  const dropoffSuggestions = document.getElementById("dropoffSuggestions");

  const useGpsBtn = document.getElementById("useGps");
  const useDriverAsPickupBtn = document.getElementById("useDriverAsPickup");
  const calculateBtn = document.getElementById("calculateBtn");
  const resultEl = document.getElementById("result");

  const modeTaxi = document.getElementById("modeTaxi");
  const modeDoktor = document.getElementById("modeDoktor");

  let mode = "taxi";

  let driverLocation = null;
  let pickupLocation = null;
  let dropoffLocation = null;

  // MAPA
  const map = L.map("map", {
    zoomControl: false,
  }).setView([48.5, 19.5], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "",
  }).addTo(map);

  let driverMarker = null;
  let pickupMarker = null;
  let dropoffMarker = null;
  let routeLayer1 = null;
  let routeLayer2 = null;

  function updateMarker(type, loc) {
    if (!loc) return;

    const icon = L.circleMarker([loc.lat, loc.lon], {
      radius: 7,
      weight: 2,
      color:
        type === "driver"
          ? "#3ddcff"
          : type === "pickup"
          ? "#ffd54f"
          : "#ff5252",
      fillColor:
        type === "driver"
          ? "#3ddcff"
          : type === "pickup"
          ? "#ffd54f"
          : "#ff5252",
      fillOpacity: 0.9,
    });

    if (type === "driver") {
      if (driverMarker) map.removeLayer(driverMarker);
      driverMarker = icon.addTo(map);
    } else if (type === "pickup") {
      if (pickupMarker) map.removeLayer(pickupMarker);
      pickupMarker = icon.addTo(map);
    } else if (type === "dropoff") {
      if (dropoffMarker) map.removeLayer(dropoffMarker);
      dropoffMarker = icon.addTo(map);
    }

    const points = [];
    if (driverMarker) points.push(driverMarker.getLatLng());
    if (pickupMarker) points.push(pickupMarker.getLatLng());
    if (dropoffMarker) points.push(dropoffMarker.getLatLng());

    if (points.length) {
      const bounds = L.latLngBounds(points);
      map.fitBounds(bounds, { padding: [30, 30] });
    }
  }

  function clearRoutes() {
    if (routeLayer1) {
      map.removeLayer(routeLayer1);
      routeLayer1 = null;
    }
    if (routeLayer2) {
      map.removeLayer(routeLayer2);
      routeLayer2 = null;
    }
  }

  function drawRoute(coords, color) {
    const latlngs = coords.map((c) => [c[1], c[0]]);
    return L.polyline(latlngs, {
      color,
      weight: 4,
      opacity: 0.8,
    }).addTo(map);
  }

  function setMode(newMode) {
    mode = newMode;
    modeTaxi.classList.toggle("active", mode === "taxi");
    modeDoktor.classList.toggle("active", mode === "doktor");
  }

  modeTaxi.onclick = () => setMode("taxi");
  modeDoktor.onclick = () => setMode("doktor");

  function debounce(fn, delay) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  async function fetchSuggestions(query) {
    if (!query || query.length < 3) return [];
    const url = `https://api.openrouteservice.org/geocode/autocomplete?api_key=${encodeURIComponent(
      ORS_API_KEY
    )}&text=${encodeURIComponent(query)}&size=5&boundary.country=SK`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      return (
        data.features?.map((f) => ({
          label: f.properties.label,
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0],
        })) || []
      );
    } catch {
      return [];
    }
  }

  function showSuggestions(container, items, onSelect) {
    if (!items.length) {
      container.style.display = "none";
      return;
    }
    container.innerHTML = "";
    items.forEach((item) => {
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.textContent = item.label;
      div.onclick = () => {
        onSelect(item);
        container.style.display = "none";
      };
      container.appendChild(div);
    });
    container.style.display = "block";
  }

  const handleDriverInput = debounce(async () => {
    const q = driverInput.value.trim();
    const suggestions = await fetchSuggestions(q);
    showSuggestions(driverSuggestions, suggestions, (item) => {
      driverLocation = item;
      driverInput.value = item.label;
      updateMarker("driver", driverLocation);
    });
  }, 300);

  const handlePickupInput = debounce(async () => {
    const q = pickupInput.value.trim();
    const suggestions = await fetchSuggestions(q);
    showSuggestions(pickupSuggestions, suggestions, (item) => {
      pickupLocation = item;
      pickupInput.value = item.label;
      updateMarker("pickup", pickupLocation);
    });
  }, 300);

  const handleDropoffInput = debounce(async () => {
    const q = dropoffInput.value.trim();
    const suggestions = await fetchSuggestions(q);
    showSuggestions(dropoffSuggestions, suggestions, (item) => {
      dropoffLocation = item;
      dropoffInput.value = item.label;
      updateMarker("dropoff", dropoffLocation);
    });
  }, 300);

  driverInput.oninput = () => {
    driverLocation = null;
    handleDriverInput();
  };
  pickupInput.oninput = () => {
    pickupLocation = null;
    handlePickupInput();
  };
  dropoffInput.oninput = () => {
    dropoffLocation = null;
    handleDropoffInput();
  };

  document.addEventListener("click", (e) => {
    if (!driverSuggestions.contains(e.target) && e.target !== driverInput)
      driverSuggestions.style.display = "none";
    if (!pickupSuggestions.contains(e.target) && e.target !== pickupInput)
      pickupSuggestions.style.display = "none";
    if (!dropoffSuggestions.contains(e.target) && e.target !== dropoffInput)
      dropoffSuggestions.style.display = "none";
  });

  // GPS
  useGpsBtn.onclick = () => {
    if (!navigator.geolocation) {
      alert("Toto zariadenie nepodporuje GPS.");
      return;
    }

    useGpsBtn.disabled = true;
    useGpsBtn.textContent = "Získavam polohu...";

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        try {
          const url = `https://api.openrouteservice.org/geocode/reverse?api_key=${encodeURIComponent(
            ORS_API_KEY
          )}&point.lon=${lon}&point.lat=${lat}`;
          const res = await fetch(url);
          const data = await res.json();
          const label =
            data.features?.[0]?.properties?.label || "Moja poloha";

          driverLocation = { lat, lon, label };
          driverInput.value = label;
          updateMarker("driver", driverLocation);
        } catch {
          alert("Nepodarilo sa získať adresu z GPS.");
        }

        useGpsBtn.disabled = false;
        useGpsBtn.textContent = "Použiť moju polohu (GPS)";
      },
      () => {
        alert("Nepodarilo sa získať GPS polohu.");
        useGpsBtn.disabled = false;
        useGpsBtn.textContent = "Použiť moju polohu (GPS)";
      }
    );
  };

  // Použiť polohu vodiča ako nástup
  useDriverAsPickupBtn.onclick = () => {
    if (!driverLocation) {
      alert("Najprv vyberte alebo načítajte polohu vodiča.");
      return;
    }
    pickupLocation = { ...driverLocation };
    pickupInput.value = driverLocation.label;
    updateMarker("pickup", pickupLocation);
  };

  // Routing
  async function getRoute(from, to) {
    const url =
      "https://api.openrouteservice.org/v2/directions/driving-car/geojson";
    const body = {
      coordinates: [
        [from.lon, from.lat],
        [to.lon, to.lat],
      ],
    };
    const res = await fetch(url, {
      method: "POST",
      headers: {
        Authorization: ORS_API_KEY,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    const meters = data.features[0].properties.summary.distance;
    const coords = data.features[0].geometry.coordinates;
    return { km: meters / 1000, coords };
  }

  function euro(v) {
    return v.toFixed(2).replace(".", ",") + " €";
  }

  // Výpočet ceny
  calculateBtn.onclick = async () => {
    if (!driverLocation || !pickupLocation || !dropoffLocation) {
      alert("Vyplňte polohu vodiča, nástup aj výstup.");
      return;
    }

    calculateBtn.disabled = true;
    calculateBtn.textContent = "Počítam...";
    clearRoutes();

    try {
      // FIXNÝ DOJAZD 1 €
      let kmDojazd = 0;
      let cenaDojazd = 1.0;
      let dojazdCoords = [];

      const samePoint =
        driverLocation.lat === pickupLocation.lat &&
        driverLocation.lon === pickupLocation.lon;

      if (!samePoint) {
        const dojazd = await getRoute(driverLocation, pickupLocation);
        kmDojazd = dojazd.km;
        cenaDojazd = kmDojazd * 0.4;
        dojazdCoords = dojazd.coords;
      }

      const trasa = await getRoute(pickupLocation, dropoffLocation);
      const kmTrasa = trasa.km;
      const cenaTrasa = kmTrasa * 0.85;

      const zaklad = cenaDojazd + cenaTrasa;

      let final = zaklad;
      let note = "";

      // ZĽAVA 45 %
      if (mode === "doktor") {
        final = zaklad * 0.55;
        note =
          "Uplatnená zľava 45% – cena je za 1 osobu na danej trase.";
      }

      if (dojazdCoords.length)
        routeLayer1 = drawRoute(dojazdCoords, "#3ddcff");
      routeLayer2 = drawRoute(trasa.coords, "#ff5252");

      resultEl.innerHTML = `
        <div class="badge">${
          mode === "taxi" ? "Taxi" : "Doktor Flajster"
        }</div>

        <div><strong>Dojazd vodiča:</strong> ${
          samePoint ? "0.00" : kmDojazd.toFixed(2)
        } km = ${euro(cenaDojazd)}</div>

        <div><strong>Trasa s klientom:</strong> ${kmTrasa.toFixed(
          2
        )} km × 0,85 €/km = ${euro(cenaTrasa)}</div>

        <div style="margin-top:6px;"><strong>Základná cena:</strong> ${euro(
          zaklad
        )}</div>

        ${
          mode === "doktor"
            ? `<div><strong>Po zľave 45%:</strong> ${euro(
                final
              )}</div><div class="warning">${note}</div>`
            : `<div><strong>Konečná cena:</strong> ${euro(final)}</div>`
        }

        <div class="small" style="margin-top:8px;">
          Dojazd: z polohy vodiča na nástup. Trasa: z nástupu na výstup.
        </div>
      `;
      resultEl.style.display = "block";
    } catch {
      alert("Nepodarilo sa získať trasu z OpenRouteService.");
    }

    calculateBtn.disabled = false;
    calculateBtn.textContent = "Vypočítať cenu";
  };
</script>
<!-- PWA registrácia (nevadí, ak sw.js neexistuje – ignoruje sa) -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(() => {});
  }
</script>

  </div> <!-- koniec .app -->
</body>
</html>

